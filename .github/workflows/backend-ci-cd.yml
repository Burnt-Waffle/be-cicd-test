name: Backend CI/CD with Docker

on:
  pull_request:
    types: [opened, synchronize, closed]
    branches: [dev, main]

permissions:
  id-token: write # AWS OIDC ì¸ì¦
  contents: read

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: backend

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # 1. ë¹Œë“œ ë° ë„ì»¤ ì´ë¯¸ì§€ í‘¸ì‹œ (CI)
  build-and-push:
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup JDK 21 and 25
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: |
            21
            25

      # Gradle ë¹Œë“œ ìºì‹œ (ì„ íƒì , ë” ë¹ ë¥¸ ë¹Œë“œ)
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3 # ë¹Œë“œ ìºì‹±

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸ - ì†ë„ ìµœì í™”, í•„ìš”ì‹œ í¬í•¨)
      - name: Build with Gradle
        run: ./gradlew build -x test

      # ë¹Œë“œëœ JAR ì´ë¦„ì„ ê³ ì •ëœ ì´ë¦„ìœ¼ë¡œ ë³€ê²½ (Dockerfile COPY í¸ì˜ì„±)
      - name: Rename JAR
        run: |
          JAR_FILE=$(find build/libs -name "*.jar" | head -n 1)
          if [ -f "$JAR_FILE" ]; then
            mv "$JAR_FILE" backend-app.jar
          fi

      # AWS ìê²© ì¦ëª… ì„¤ì • (OIDC ë°©ì‹)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # ECR ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:pr-$PR_HEAD_SHA .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:pr-$PR_HEAD_SHA

      # í˜„ì¬ ì‹œê°„ êµ¬í•˜ê¸° (KST)
      - name: Get Current Time
        if: always()
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: 'YYYY-MM-DD HH:mm:ss'
          utcOffset: "+09:00" # í•œêµ­ ì‹œê°„
          timezone: 'Asia/Seoul'

      # Phase 5: Discord ì„±ê³µ ì•Œë¦¼
      - name: Discord Notification - Success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "âœ… BE CI ì„±ê³µ",
              "color": 5763719,
              "fields": [
                {"name": "Repository", "value": "${{ github.repository }}", "inline": false},
                {"name": "Merge To", "value": "${{ github.base_ref }}", "inline": false},
                {"name": "Triggered By", "value": "${{ github.actor }}", "inline": false},
                {"name": "Commit/PR", "value": "${{ github.event.pull_request.title }}", "inline": false},
                {"name": "Actions Log", "value": "[Link to Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: 'CI íŒŒì´í”„ë¼ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. <@&${{ secrets.DISCORD_ROLE_BACKEND }}>'

      # Phase 5: Discord ì‹¤íŒ¨ ì•Œë¦¼
      - name: Discord Notification - Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "ğŸš¨ BE CI ì‹¤íŒ¨",
              "color": 15548997,
              "fields": [
                {"name": "Repository", "value": "${{ github.repository }}", "inline": false},
                {"name": "Merge To", "value": "${{ github.base_ref }}", "inline": false},
                {"name": "Triggered By", "value": "${{ github.actor }}", "inline": false},
                {"name": "Commit/PR", "value": "${{ github.event.pull_request.title }}", "inline": false},
                {"name": "Actions Log", "value": "[Link to Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: 'CI íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. <@&${{ secrets.DISCORD_ROLE_BACKEND_ONCALL }}> '

  # 2. ì´ë¯¸ì§€ ë¦¬íƒœê¹… (Merge ì‹œ ì‹¤í–‰)
  promote-image:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      # Deployì—ì„œ ì‚¬ìš©í•  ìµœì¢… ì´ë¯¸ì§€ URI ì „ë‹¬
      final_image_uri: ${{ steps.retag.outputs.FINAL_URI }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Retag Image
        id: retag
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          # 1. ì›ë³¸ íƒœê·¸ (PR ë•Œ ë¹Œë“œí•œ ê²ƒ)
          SOURCE_TAG: pr-${{ github.event.pull_request.head.sha }}
          # 2. ëª©í‘œ íƒœê·¸ (ì‹¤ì œ ë°°í¬ë  Merge Commit SHA)
          TARGET_TAG: ${{ github.event.pull_request.merge_commit_sha }}
          # 3. ë¸Œëœì¹˜ ì •ë³´
          BASE_BRANCH: ${{ github.base_ref }}
        run: |
          echo "Finding image with tag: $SOURCE_TAG..."
          
          # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ì§€ ì°¾ê¸°)
          MANIFEST=$(aws ecr batch-get-image \
            --repository-name $ECR_REPOSITORY \
            --image-ids imageTag=$SOURCE_TAG \
            --query 'images[].imageManifest' \
            --output text)
            
          if [ -z "$MANIFEST" ] || [ "$MANIFEST" == "None" ]; then
            echo "Error: Source image ($SOURCE_TAG) not found in ECR!"
            exit 1
          fi

          echo "Image found! Retagging to: $TARGET_TAG"

          # 1. Merge SHA íƒœê·¸ ë¶™ì´ê¸°
          aws ecr put-image \
            --repository-name $ECR_REPOSITORY \
            --image-tag $TARGET_TAG \
            --image-manifest "$MANIFEST" || echo "Image $TARGET_TAG already exists. Skipping retag."
            
          # 2. í™˜ê²½ë³„ Latest íƒœê·¸ ë¶™ì´ê¸°
          if [[ "$BASE_BRANCH" == "dev" ]]; then
            aws ecr put-image --repository-name $ECR_REPOSITORY --image-tag dev-latest --image-manifest "$MANIFEST" || echo "dev-latest already exists on this image. Skipping."
          elif [[ "$BASE_BRANCH" == "main" ]]; then
            aws ecr put-image --repository-name $ECR_REPOSITORY --image-tag staging-latest --image-manifest "$MANIFEST" || echo "staging-latest already exists on this image. Skipping."
            aws ecr put-image --repository-name $ECR_REPOSITORY --image-tag prod-latest --image-manifest "$MANIFEST" || echo "prod-latest already exists on this image. Skipping."
          fi
          
          # ìµœì¢…ì ìœ¼ë¡œ ë°°í¬ì— ì‚¬ìš©í•  URI ì¶œë ¥
          echo "FINAL_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$TARGET_TAG" >> $GITHUB_OUTPUT

  # 2. Dev ë°°í¬ (dev ë¸Œëœì¹˜ Merge ì‹œ)  
  deploy-dev:
    needs: promote-image
    if: github.event.pull_request.merged == true && github.base_ref == 'dev'
    uses: ./.github/workflows/deploy-dev.yml
    with:
      environment: dev
      image_uri: ${{ needs.promote-image.outputs.final_image_uri }}
      instance_tag_name: "Environment" # EC2 íƒœê·¸ Key
      instance_tag_value: "dev" # EC2 íƒœê·¸ Value
      pr_number: ${{ github.event.pull_request.number }}
      pr_title: ${{ github.event.pull_request.title }}
      base_ref: ${{ github.base_ref }}
      actor: ${{ github.actor }}
      run_id: ${{ github.run_id }}
      repository: ${{ github.repository }}
    secrets: inherit

  # 3. Staging ë°°í¬ (main ë¸Œëœì¹˜ Merge ì‹œ)
  deploy-staging:
    needs: promote-image
    if: github.event.pull_request.merged == true && github.base_ref == 'main'
    uses: ./.github/workflows/deploy-asg-rolling.yml
    with:
      environment: staging
      image_uri: ${{ needs.promote-image.outputs.final_image_uri }}
      asg_name: "backend-staging-asg"
      lt_id: "lt-0xxxxxxxxxxxxxx" # Stagingìš© ì‹œì‘ í…œí”Œë¦¿ ID
      pr_number: ${{ github.event.pull_request.number }}
      pr_title: ${{ github.event.pull_request.title }}
      base_ref: ${{ github.base_ref }}
      actor: ${{ github.actor }}
      run_id: ${{ github.run_id }}
      repository: ${{ github.repository }}
    secrets: inherit
  
#   # 4. Production ë°°í¬ (Staging ì„±ê³µ í›„ ìŠ¹ì¸ í•„ìš”)
#   deploy-production:
#     needs: [promote-image, deploy-staging]
#     if: github.event.pull_request.merged == true && github.base_ref == 'main'
#     uses: ./.github/workflows/deploy-asg-rolling.yml
#     with:
#       environment: production
#       image_uri: ${{needs.promote-image.outputs.final_image_uri}}
#       asg_name: "backend-prod-asg"
#       lt_id: "lt-yyyyyyyy"
#     secrets: inherit