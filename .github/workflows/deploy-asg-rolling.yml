name: Deploy ASG via Rolling Update

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Î∞∞Ìè¨ ÌôòÍ≤Ω (staging / production)'
      image_uri:
        required: true
        type: string
        description: 'Î∞∞Ìè¨Ìï† Docker Ïù¥ÎØ∏ÏßÄ URI'
      asg_name:
        required: true
        type: string
        description: 'Auto Scaling Group Ïù¥Î¶Ñ'
      lt_id:
        required: true
        type: string
        description: 'Launch Template ID'
      pr_number:
        required: true
        type: number
      pr_title:
        required: true
        type: string
      base_ref:
        required: true
        type: string
      actor:
        required: true
        type: string
      repository:
        required: true
        type: string
      run_id:
        required: true
        type: string

    secrets:
      DISCORD_WEBHOOK_URL:
        required: true
      DISCORD_ROLE_BACKEND:
        required: true
      DISCORD_ROLE_BACKEND_ONCALL:
        required: true
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ap-northeast-2

jobs:
  deploy-asg:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }} 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ÌÉúÍ∑∏ Í≥ÑÏÇ∞ÏùÑ ÏúÑÌï¥ Ï†ÑÏ≤¥ Ïª§Î∞ã Î°úÍ∑∏Î•º Í∞ÄÏ†∏Ïò¥

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # 1. ÏãúÎ©òÌã± Î≤ÑÏ†Ñ ÌÉúÍ∑∏ ÏÉùÏÑ±
      - name: Create Semantic Version Tag
        if: inputs.environment == 'production'
        id: create_tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Calculating next version..."
          
          # 1. ÏµúÏã† ÌÉúÍ∑∏ Í∞ÄÏ†∏Ïò§Í∏∞ (ÏóÜÏúºÎ©¥ v0.0.0)
          # git describe --tags: Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÌÉúÍ∑∏ Ï∞æÍ∏∞
          # --abbrev=0: Ïª§Î∞ã Ìï¥Ïãú ÌëúÏãú Ïïà Ìï® (ÌÉúÍ∑∏Îßå)
          # 2>/dev/null: ÌÉúÍ∑∏Í∞Ä ÏóÜÏùÑ Îïå ÏóêÎü¨ Ïà®Í∏∞Í∏∞
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "v*.*.*" 2>/dev/null || echo "v0.0.0")
          echo "Current Latest Tag: $LATEST_TAG"
          
          # 2. Î≤ÑÏ†Ñ ÌååÏã± (v Ï†úÍ±∞ ÌõÑ .ÏúºÎ°ú Î∂ÑÎ¶¨)
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          # 3. Patch Î≤ÑÏ†ÑÎßå 1 Ï¶ùÍ∞Ä
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          
          echo "New Version to be created: $NEW_VERSION"
          
          # 4. Git ÌÉúÍ∑∏ ÏÉùÏÑ± Î∞è Ìë∏Ïãú
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a $NEW_VERSION -m "Production Release $NEW_VERSION
          PR: #${{ inputs.pr_number }} - ${{ inputs.pr_title }}
          Commit: ${{ github.sha }}
          Actor: ${{ inputs.actor }}"
          
          git push origin $NEW_VERSION
          
          # 5. Îã§Ïùå Îã®Í≥ÑÏóêÏÑú Ïì∏ Ïàò ÏûàÍ≤å outputÏúºÎ°ú ÎÇ¥Î≥¥ÎÉÑ
          echo "DEPLOY_TAG=$NEW_VERSION" >> $GITHUB_ENV
          echo "Tag created: $NEW_VERSION"

      # 2. ECR Ïù¥ÎØ∏ÏßÄÏóê ÏÉà ÌÉúÍ∑∏ Î∂ôÏù¥Í∏∞
      - name: Add Release Tag to ECR Image
        if: inputs.environment == 'production'
        env:
          DEPLOY_TAG: ${{ env.DEPLOY_TAG }}
          IMAGE_URI: ${{ inputs.image_uri }}
        run: |
          echo "Attaching tag $DEPLOY_TAG to Docker Image..."
          
          # 1. Ïù¥ÎØ∏ÏßÄ URI Î∂ÑÌï¥ (Repo Ïù¥Î¶Ñ, Í∏∞Ï°¥ SHA ÌÉúÍ∑∏)
          ECR_REPO=$(echo $IMAGE_URI | cut -d/ -f2 | cut -d: -f1)
          SHA_TAG=$(echo $IMAGE_URI | cut -d: -f2)
          
          # 2. Îß§ÎãàÌéòÏä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
          MANIFEST=$(aws ecr batch-get-image \
            --repository-name $ECR_REPO \
            --image-ids imageTag=$SHA_TAG \
            --query 'images[].imageManifest' \
            --output text)
            
          # 3. ÏÉà Î≤ÑÏ†Ñ ÌÉúÍ∑∏ Î∂ôÏù¥Í∏∞
          aws ecr put-image \
            --repository-name $ECR_REPO \
            --image-tag $DEPLOY_TAG \
            --image-manifest "$MANIFEST"
            
          echo "ECR Image tagged with $DEPLOY_TAG"

      # 3. ÏãúÏûë ÌÖúÌîåÎ¶ø(Launch Template) ÏÉà Î≤ÑÏ†Ñ ÏÉùÏÑ±
      - name: Create New Launch Template Version
        id: update-lt
        env:
          DEPLOY_TAG: ${{ env.DEPLOY_TAG }}
        run: |
          echo "Fetching current User Data for LT ID: ${{ inputs.lt_id }}..."
          
          # 1. ÏµúÏã† Î≤ÑÏ†ÑÏùò Launch Template Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
          CURRENT_LT=$(aws ec2 describe-launch-template-versions \
            --launch-template-id ${{ inputs.lt_id }} \
            --versions "\$Latest" \
            --query 'LaunchTemplateVersions[0].LaunchTemplateData')

          # 2. User Data ÎîîÏΩîÎî© (Base64 -> Text)
          CURRENT_USER_DATA_BASE64=$(echo $CURRENT_LT | jq -r '.UserData')
          CURRENT_USER_DATA=$(echo $CURRENT_USER_DATA_BASE64 | base64 --decode)

          # 3. User Data ÎÇ¥Ïùò Ïù¥ÎØ∏ÏßÄ URI Î≥ÄÍ≤Ω (sed ÏÇ¨Ïö©)
          # "export IMAGE_URI=" Îí§Ïóê Ïò§Îäî Ï£ºÏÜåÎ•º ÏÉà Ï£ºÏÜåÎ°ú ÍµêÏ≤¥
          NEW_USER_DATA=$(echo "$CURRENT_USER_DATA" | sed "s|export IMAGE_URI=.*|export IMAGE_URI=\"${{ inputs.image_uri }}\"|g")

          # 4. Î≥ÄÍ≤ΩÎêú User Data Îã§Ïãú Ïù∏ÏΩîÎî© (Text -> Base64)
          NEW_USER_DATA_BASE64=$(echo "$NEW_USER_DATA" | base64 -w 0)

          echo "Creating new Launch Template version..."
          
          # 5. ÏÉà Î≤ÑÏ†Ñ Î∞úÌñâ
          NEW_VERSION=$(aws ec2 create-launch-template-version \
            --launch-template-id ${{ inputs.lt_id }} \
            --source-version "\$Latest" \
            --version-description "Release ${{ env.DEPLOY_TAG }}" \
            --launch-template-data "{\"UserData\":\"$NEW_USER_DATA_BASE64\"}" \
            --query 'LaunchTemplateVersion.VersionNumber' \
            --output text)

          echo "Created Launch Template Version: $NEW_VERSION"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT

      # 4. ASG Ïù∏Ïä§ÌÑ¥Ïä§ Î¶¨ÌîÑÎ†àÏãú ÏãúÏûë (Rolling Update)
      - name: Start Instance Refresh
        id: refresh
        run: |
          echo "Starting Instance Refresh for ASG: ${{ inputs.asg_name }}..."

          # Í∏∞Ï°¥Ïóê ÏßÑÌñâ Ï§ëÏù∏ Î¶¨ÌîÑÎ†àÏãúÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† Ï∑®ÏÜå
          CURRENT_REFRESH_ID=$(aws autoscaling describe-instance-refreshes \
            --auto-scaling-group-name ${{ inputs.asg_name }} \
            --query 'InstanceRefreshes[?Status==`InProgress`].InstanceRefreshId' \
            --output text)
            
          if [ ! -z "$CURRENT_REFRESH_ID" ] && [ "$CURRENT_REFRESH_ID" != "None" ]; then
            echo "Found in-progress refresh ($CURRENT_REFRESH_ID). Cancelling it now..."
            aws autoscaling cancel-instance-refresh --auto-scaling-group-name ${{ inputs.asg_name }}
            
            # Ï∑®ÏÜåÎê† ÎïåÍπåÏßÄ Ïû†Ïãú ÎåÄÍ∏∞
            echo "Waiting for cancellation..."
            sleep 10
          fi
          
          # MinHealthyPercentage:
          # - Production (2ÎåÄ): 50% (1ÎåÄÎäî Ï£ΩÏù¥Í≥† 1ÎåÄÎäî ÏÇ¥Î¶º -> Î°§ÎßÅ)
          # - Staging (1ÎåÄ): 0% (ÏÉàÍ±∞ ÎùÑÏö∞Í≥† ÏòõÎÇ†Í±∞ Ï£ΩÏù¥Í±∞ÎÇò, Ïû†Ïãú Îã§Ïö¥ÌÉÄÏûÑ ÌóàÏö©)
          if [ "${{ inputs.environment }}" == "production" ]; then
            MIN_HEALTHY=50
          else
            MIN_HEALTHY=0 # 1ÎåÄÏùº Í≤ΩÏö∞ 100%Î•º Ïú†ÏßÄÌïòÎ†§Î©¥ Max CapacityÍ∞Ä 2Ïó¨Ïïº Ìï®
          fi
          
          echo "Using MinHealthyPercentage: $MIN_HEALTHY"

          # Ïù∏Ïä§ÌÑ¥Ïä§ Î¶¨ÌîÑÎ†àÏãú ÏãúÏûë Î™ÖÎ†π
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ inputs.asg_name }} \
            --preferences "{\"MinHealthyPercentage\": $MIN_HEALTHY, \"InstanceWarmup\": 180, \"AutoRollback\": true}" \
            --desired-configuration "{\"LaunchTemplate\":{\"LaunchTemplateId\":\"${{ inputs.lt_id }}\",\"Version\":\"${{ steps.update-lt.outputs.VERSION }}\"}}" \
            --query 'InstanceRefreshId' \
            --output text)

          echo "Instance Refresh ID: $REFRESH_ID"
          echo "REFRESH_ID=$REFRESH_ID" >> $GITHUB_OUTPUT

      # 5. Î∞∞Ìè¨ ÏôÑÎ£å ÎåÄÍ∏∞ (Polling)
      - name: Wait for Instance Refresh
        run: |
          echo "Waiting for Instance Refresh to complete..."
          REFRESH_ID=${{ steps.refresh.outputs.REFRESH_ID }}
          ASG_NAME=${{ inputs.asg_name }}
          
          while :; do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name $ASG_NAME \
              --instance-refresh-ids $REFRESH_ID \
              --query 'InstanceRefreshes[0].Status' \
              --output text)
            
            echo "Current Status: $STATUS"

            if [[ "$STATUS" == "Successful" ]]; then
              echo "Instance Refresh Completed Successfully!"
              break
            elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" ]]; then
              echo "Instance Refresh Failed!"
              # Ïã§Ìå® ÏÉÅÏÑ∏ ÏÇ¨Ïú† Ï∂úÎ†•
              aws autoscaling describe-instance-refreshes \
                --auto-scaling-group-name $ASG_NAME \
                --instance-refresh-ids $REFRESH_ID
              exit 1
            elif [[ "$STATUS" == "RollbackSuccessful" ]]; then
               echo "Deployment Failed but Auto-Rollback Succeeded!"
               exit 1
            elif [[ "$STATUS" == "RollbackFailed" ]]; then
               echo "Deployment Failed AND Auto-Rollback Failed!"
               exit 1
            fi

            echo "Waiting 10s..."
            sleep 10
          done

      # 6. ÏÑ±Í≥µ Ïãú ASG ÏÑ§Ï†ïÏùÑ ÏµúÏã† Î≤ÑÏ†ÑÏúºÎ°ú ÌôïÏ†ï
      - name: Update ASG Configuration to New Version
        if: success()
        run: |
          echo "Updating ASG to use Version ${{ steps.update-lt.outputs.VERSION }}..."
          
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name ${{ inputs.asg_name }} \
            --launch-template "LaunchTemplateId=${{ inputs.lt_id }},Version=${{ steps.update-lt.outputs.VERSION }}"

          echo "ASG Default Version Updated!"

      # ÌòÑÏû¨ ÏãúÍ∞Ñ Íµ¨ÌïòÍ∏∞ (KST)
      - name: Get Current Time
        if: always()
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: 'YYYY-MM-DD HH:mm:ss'
          utcOffset: "+09:00" # ÌïúÍµ≠ ÏãúÍ∞Ñ
          timezone: 'Asia/Seoul'

      # ÏÑ±Í≥µ ÏïåÎ¶º
      - name: Discord Notification - Success
        if: success()
        env:
          DEPLOY_TAG: ${{ env.DEPLOY_TAG }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "‚úÖ ${{ inputs.environment }} BE Î∞∞Ìè¨(CD) ÏÑ±Í≥µ",
              "color": 5763719,
              "fields": [
                {"name": "Repository", "value": "${{ inputs.repository }}", "inline": false},
                {"name": "Environment", "value": "${{ inputs.environment }}", "inline": true},
                {"name": "Merge To", "value": "${{ inputs.base_ref }}", "inline": true},
                {"name": "Triggered By", "value": "${{ inputs.actor }}", "inline": false},
                {"name": "Commit/PR", "value": "${{ inputs.pr_title }}", "inline": false},
                {"name": "Version", "value": "${{ env.DEPLOY_TAG || 'N/A' }}", "inline": true},
                {"name": "Actions Log", "value": "[Link](https://github.com/${{ inputs.repository }}/actions/runs/${{ inputs.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: '${{ inputs.environment }} Î∞∞Ìè¨ ÏôÑÎ£å! <@&${{ secrets.DISCORD_ROLE_BACKEND }}>'

      # Ïã§Ìå® ÏïåÎ¶º
      - name: Discord Notification - Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "üö® ${{ inputs.environment }} BE Î∞∞Ìè¨(CD) Ïã§Ìå®",
              "color": 15548997,
              "fields": [
                  {"name": "Repository", "value": "${{ inputs.repository }}", "inline": false},
                  {"name": "Environment", "value": "${{ inputs.environment }}", "inline": true},
                  {"name": "Merge To", "value": "${{ inputs.base_ref }}", "inline": true},
                  {"name": "Triggered By", "value": "${{ inputs.actor }}", "inline": false},
                  {"name": "Commit/PR", "value": "${{ inputs.pr_title }}", "inline": false},
                  {"name": "Actions Log", "value": "[Link to Action](https://github.com/${{ inputs.repository }}/actions/runs/${{ inputs.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: '${{ inputs.environment }} Î∞∞Ìè¨ Ïã§Ìå®! Î°úÍ∑∏ ÌôïÏù∏ ÌïÑÏöî. <@&${{ secrets.DISCORD_ROLE_BACKEND_ONCALL }}>'