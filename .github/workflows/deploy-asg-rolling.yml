name: Deploy ASG via Rolling Update

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'ë°°í¬ í™˜ê²½ (staging / production)'
      image_uri:
        required: true
        type: string
        description: 'ë°°í¬í•  Docker ì´ë¯¸ì§€ URI'
      asg_name:
        required: true
        type: string
        description: 'Auto Scaling Group ì´ë¦„'
      lt_id:
        required: true
        type: string
        description: 'Launch Template ID'
      pr_number:
        required: true
        type: number
      pr_title:
        required: true
        type: string
      base_ref:
        required: true
        type: string
      actor:
        required: true
        type: string
      repository:
        required: true
        type: string
      run_id:
        required: true
        type: string

    secrets:
      DISCORD_WEBHOOK_URL:
        required: true
      DISCORD_ROLE_BACKEND:
        required: true
      DISCORD_ROLE_BACKEND_ONCALL:
        required: true
      AWS_ROLE_ARN:
        required: true
      STG_ALB_DNS:
        required: true
      PROD_ALB_DNS:
        required: true


permissions:
  id-token: write
  contents: write

env:
  AWS_REGION: ap-northeast-2

jobs:
  deploy-asg:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }} 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # íƒœê·¸ ê³„ì‚°ì„ ìœ„í•´ ì „ì²´ ì»¤ë°‹ ë¡œê·¸ë¥¼ ê°€ì ¸ì˜´

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # 1. ì‹œë©˜í‹± ë²„ì „ íƒœê·¸ ìƒì„±
      - name: Create Semantic Version Tag
        if: inputs.environment == 'production'
        id: create_tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Calculating next version..."
          
          # 1. ìµœì‹  íƒœê·¸ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ v0.0.0)
          # git describe --tags: ê°€ì¥ ê°€ê¹Œìš´ íƒœê·¸ ì°¾ê¸°
          # --abbrev=0: ì»¤ë°‹ í•´ì‹œ í‘œì‹œ ì•ˆ í•¨ (íƒœê·¸ë§Œ)
          # 2>/dev/null: íƒœê·¸ê°€ ì—†ì„ ë•Œ ì—ëŸ¬ ìˆ¨ê¸°ê¸°
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "v*.*.*" 2>/dev/null || echo "v0.0.0")
          echo "Current Latest Tag: $LATEST_TAG"
          
          # 2. ë²„ì „ íŒŒì‹± (v ì œê±° í›„ .ìœ¼ë¡œ ë¶„ë¦¬)
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          # 3. Patch ë²„ì „ë§Œ 1 ì¦ê°€
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${NEW_PATCH}"
          
          echo "New Version to be created: $NEW_VERSION"
          
          # 4. Git íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a $NEW_VERSION -m "Production Release $NEW_VERSION
          PR: #${{ inputs.pr_number }} - ${{ inputs.pr_title }}
          Commit: ${{ github.sha }}
          Actor: ${{ inputs.actor }}"
          
          git push origin $NEW_VERSION
          
          # 5. ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì“¸ ìˆ˜ ìˆê²Œ outputìœ¼ë¡œ ë‚´ë³´ëƒ„
          echo "DEPLOY_TAG=$NEW_VERSION" >> $GITHUB_ENV
          echo "Tag created: $NEW_VERSION"

      # 2. ECR ì´ë¯¸ì§€ì— ìƒˆ íƒœê·¸ ë¶™ì´ê¸°
      - name: Add Release Tag to ECR Image
        if: inputs.environment == 'production'
        env:
          DEPLOY_TAG: ${{ env.DEPLOY_TAG }}
          IMAGE_URI: ${{ inputs.image_uri }}
        run: |
          echo "Attaching tag $DEPLOY_TAG to Docker Image..."
          
          # 1. ì´ë¯¸ì§€ URI ë¶„í•´ (Repo ì´ë¦„, ê¸°ì¡´ SHA íƒœê·¸)
          ECR_REPO=$(echo $IMAGE_URI | cut -d/ -f2 | cut -d: -f1)
          SHA_TAG=$(echo $IMAGE_URI | cut -d: -f2)
          
          # 2. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
          MANIFEST=$(aws ecr batch-get-image \
            --repository-name $ECR_REPO \
            --image-ids imageTag=$SHA_TAG \
            --query 'images[].imageManifest' \
            --output text)
            
          # 3. ìƒˆ ë²„ì „ íƒœê·¸ ë¶™ì´ê¸°
          aws ecr put-image \
            --repository-name $ECR_REPO \
            --image-tag $DEPLOY_TAG \
            --image-manifest "$MANIFEST"
            
          echo "ECR Image tagged with $DEPLOY_TAG"

      # 3. ì‹œì‘ í…œí”Œë¦¿(Launch Template) ìƒˆ ë²„ì „ ìƒì„±
      - name: Create New Launch Template Version
        id: update-lt
        env:
          DEPLOY_TAG: ${{ env.DEPLOY_TAG }}
        run: |
          echo "Fetching current User Data for LT ID: ${{ inputs.lt_id }}..."
          
          # 1. ìµœì‹  ë²„ì „ì˜ Launch Template ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          CURRENT_LT=$(aws ec2 describe-launch-template-versions \
            --launch-template-id ${{ inputs.lt_id }} \
            --versions "\$Latest" \
            --query 'LaunchTemplateVersions[0].LaunchTemplateData')

          # 2. User Data ë””ì½”ë”© (Base64 -> Text)
          CURRENT_USER_DATA_BASE64=$(echo $CURRENT_LT | jq -r '.UserData')
          CURRENT_USER_DATA=$(echo $CURRENT_USER_DATA_BASE64 | base64 --decode)

          # 3. User Data ë‚´ì˜ ì´ë¯¸ì§€ URI ë³€ê²½ (sed ì‚¬ìš©)
          # "export IMAGE_URI=" ë’¤ì— ì˜¤ëŠ” ì£¼ì†Œë¥¼ ìƒˆ ì£¼ì†Œë¡œ êµì²´
          NEW_USER_DATA=$(echo "$CURRENT_USER_DATA" | sed "s|export IMAGE_URI=.*|export IMAGE_URI=\"${{ inputs.image_uri }}\"|g")

          # 4. ë³€ê²½ëœ User Data ë‹¤ì‹œ ì¸ì½”ë”© (Text -> Base64)
          NEW_USER_DATA_BASE64=$(echo "$NEW_USER_DATA" | base64 -w 0)

          echo "Creating new Launch Template version..."
          
          # 5. ìƒˆ ë²„ì „ ë°œí–‰
          NEW_VERSION=$(aws ec2 create-launch-template-version \
            --launch-template-id ${{ inputs.lt_id }} \
            --source-version "\$Latest" \
            --version-description "Release ${{ env.DEPLOY_TAG }}" \
            --launch-template-data "{\"UserData\":\"$NEW_USER_DATA_BASE64\"}" \
            --query 'LaunchTemplateVersion.VersionNumber' \
            --output text)

          echo "Created Launch Template Version: $NEW_VERSION"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT

      # 4. ASG ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œ ì‹œì‘ (Rolling Update)
      - name: Start Instance Refresh
        id: refresh
        run: |
          echo "Starting Instance Refresh for ASG: ${{ inputs.asg_name }}..."

          # ê¸°ì¡´ì— ì§„í–‰ ì¤‘ì¸ ë¦¬í”„ë ˆì‹œê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì·¨ì†Œ
          CURRENT_REFRESH_ID=$(aws autoscaling describe-instance-refreshes \
            --auto-scaling-group-name ${{ inputs.asg_name }} \
            --query 'InstanceRefreshes[?Status==`InProgress`].InstanceRefreshId' \
            --output text)
            
          if [ ! -z "$CURRENT_REFRESH_ID" ] && [ "$CURRENT_REFRESH_ID" != "None" ]; then
            echo "Found in-progress refresh ($CURRENT_REFRESH_ID). Cancelling it now..."
            aws autoscaling cancel-instance-refresh --auto-scaling-group-name ${{ inputs.asg_name }}
            
            # ì·¨ì†Œë  ë•Œê¹Œì§€ ì ì‹œ ëŒ€ê¸°
            echo "Waiting for cancellation..."
            sleep 10
          fi
          
          # MinHealthyPercentage:
          # - Production (2ëŒ€): 50% (1ëŒ€ëŠ” ì£½ì´ê³  1ëŒ€ëŠ” ì‚´ë¦¼ -> ë¡¤ë§)
          # - Staging (1ëŒ€): 0% (ìƒˆê±° ë„ìš°ê³  ì˜›ë‚ ê±° ì£½ì´ê±°ë‚˜, ì ì‹œ ë‹¤ìš´íƒ€ì„ í—ˆìš©)
          if [ "${{ inputs.environment }}" == "production" ]; then
            MIN_HEALTHY=50
          else
            MIN_HEALTHY=0 # 1ëŒ€ì¼ ê²½ìš° 100%ë¥¼ ìœ ì§€í•˜ë ¤ë©´ Max Capacityê°€ 2ì—¬ì•¼ í•¨
          fi
          
          echo "Using MinHealthyPercentage: $MIN_HEALTHY"

          # ì¸ìŠ¤í„´ìŠ¤ ë¦¬í”„ë ˆì‹œ ì‹œì‘ ëª…ë ¹
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ inputs.asg_name }} \
            --preferences "{\"MinHealthyPercentage\": $MIN_HEALTHY, \"InstanceWarmup\": 180, \"AutoRollback\": true}" \
            --desired-configuration "{\"LaunchTemplate\":{\"LaunchTemplateId\":\"${{ inputs.lt_id }}\",\"Version\":\"${{ steps.update-lt.outputs.VERSION }}\"}}" \
            --query 'InstanceRefreshId' \
            --output text)

          echo "Instance Refresh ID: $REFRESH_ID"
          echo "REFRESH_ID=$REFRESH_ID" >> $GITHUB_OUTPUT

      # 5. ë°°í¬ ì™„ë£Œ ëŒ€ê¸° (Polling)
      - name: Wait for Instance Refresh
        id: wait-refresh
        timeout-minutes: 10
        run: |
          echo "Waiting for Instance Refresh to complete..."
          REFRESH_ID=${{ steps.refresh.outputs.REFRESH_ID }}
          ASG_NAME=${{ inputs.asg_name }}
          
          while :; do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name $ASG_NAME \
              --instance-refresh-ids $REFRESH_ID \
              --query 'InstanceRefreshes[0].Status' \
              --output text)
            
            echo "Current Status: $STATUS"

            if [[ "$STATUS" == "Successful" ]]; then
              echo "Instance Refresh Completed Successfully!"
              break
            elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" ]]; then
              echo "Instance Refresh Failed!"
              # ì‹¤íŒ¨ ìƒì„¸ ì‚¬ìœ  ì¶œë ¥
              aws autoscaling describe-instance-refreshes \
                --auto-scaling-group-name $ASG_NAME \
                --instance-refresh-ids $REFRESH_ID
              exit 1
            elif [[ "$STATUS" == "RollbackSuccessful" ]]; then
               echo "Deployment Failed but Auto-Rollback Succeeded!"
               exit 1
            elif [[ "$STATUS" == "RollbackFailed" ]]; then
               echo "Deployment Failed AND Auto-Rollback Failed!"
               exit 1
            fi

            echo "Waiting 10s..."
            sleep 10
          done

      # 6. ì„±ê³µ ì‹œ ASG ì„¤ì •ì„ ìµœì‹  ë²„ì „ìœ¼ë¡œ í™•ì •
      - name: Update ASG Configuration to New Version
        if: success()
        run: |
          echo "Updating ASG to use Version ${{ steps.update-lt.outputs.VERSION }}..."
          
          aws autoscaling update-auto-scaling-group \
            --auto-scaling-group-name ${{ inputs.asg_name }} \
            --launch-template "LaunchTemplateId=${{ inputs.lt_id }},Version=${{ steps.update-lt.outputs.VERSION }}"

          echo "ASG Default Version Updated!"

      # 7. ASGê°€ ì„±ê³µí–ˆë‹¤ê³  í•´ë„, ì‹¤ì œë¡œ ì•±ì´ ì£½ì—ˆëŠ”ì§€ ìµœì¢… í™•ì¸
      - name: Final Health Check Verification
        if: success()
        run: |
          echo "Checking actual service health..."

          # ë‚˜ì¤‘ì—ëŠ” input environmentsë¡œ ë„ë©”ì¸ ê²½ë¡œë¡œ ë°”ê¾¸ê¸°
          if [[ "${{ inputs.environment }}" == "production" ]]; then
            TARGET_URL="http://${{ secrets.PROD_ALB_DNS }}/api/actuator/health"
          else
            TARGET_URL="http://${{ secrets.STG_ALB_DNS }}/api/actuator/health"
          fi
          
          # 30ì´ˆ ê°„ê²©ìœ¼ë¡œ 5ë²ˆ í™•ì¸ (ì´ 2ë¶„ 30ì´ˆ ë” ëŒ€ê¸°)
          for i in {1..5}; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET_URL")
            echo "Attempt $i: HTTP Status is $HTTP_STATUS"
            
            if [ "$HTTP_STATUS" == "200" ]; then
              echo "App is UP and Healthy!"
              exit 0
            fi
            
            echo "App is not healthy yet. Waiting 30s..."
            sleep 30
          done
          
          echo "ASG said Success, but App is DEAD. Failing pipeline."
          exit 1

      - name: Verify Running Launch Template Version
        if: success()
        run: |
          ASG_NAME=${{ inputs.asg_name }}
          # ë°©ê¸ˆ ë°°í¬í•œ ë²„ì „
          NEW_VERSION=${{ steps.update-lt.outputs.VERSION }}
          
          echo "Verifying if running instances are using Launch Template Version: $NEW_VERSION..."
          
          # í˜„ì¬ Running ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ë“¤ì˜ LT ë²„ì „ ì¡°íšŒ
          RUNNING_VERSIONS=$(aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names $ASG_NAME \
            --query 'AutoScalingGroups[0].Instances[?LifecycleState==`InService`].LaunchTemplate.Version' \
            --output text)
          
          echo "Detected Running Versions: $RUNNING_VERSIONS"
          
          for v in $RUNNING_VERSIONS; do
            if [ "$v" != "$NEW_VERSION" ]; then
              echo "Mismatch Detected! Instance is running version $v, but expected $NEW_VERSION"
              echo "Deployment seemed successful, but old instances are still running."
              exit 1
            fi
          done
          
          echo "All instances are running the correct version."

      # í˜„ì¬ ì‹œê°„ êµ¬í•˜ê¸° (KST)
      - name: Get Current Time
        if: always()
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: 'YYYY-MM-DD HH:mm:ss'
          utcOffset: "+09:00" # í•œêµ­ ì‹œê°„
          timezone: 'Asia/Seoul'

      # ì„±ê³µ ì•Œë¦¼
      - name: Discord Notification - Success
        if: success()
        env:
          DEPLOY_TAG: ${{ env.DEPLOY_TAG }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "âœ… ${{ inputs.environment }} BE ë°°í¬(CD) ì„±ê³µ",
              "color": 5763719,
              "fields": [
                {"name": "Repository", "value": "${{ inputs.repository }}", "inline": false},
                {"name": "Environment", "value": "${{ inputs.environment }}", "inline": true},
                {"name": "Merge To", "value": "${{ inputs.base_ref }}", "inline": true},
                {"name": "Triggered By", "value": "${{ inputs.actor }}", "inline": false},
                {"name": "Commit/PR", "value": "${{ inputs.pr_title }}", "inline": false},
                {"name": "Version", "value": "${{ env.DEPLOY_TAG || 'N/A' }}", "inline": true},
                {"name": "Actions Log", "value": "[Link](https://github.com/${{ inputs.repository }}/actions/runs/${{ inputs.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: '${{ inputs.environment }} ë°°í¬ ì™„ë£Œ! <@&${{ secrets.DISCORD_ROLE_BACKEND }}>'

      # ì‹¤íŒ¨ ì•Œë¦¼
      - name: Discord Notification - Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "ğŸš¨ ${{ inputs.environment }} BE ë°°í¬(CD) ì‹¤íŒ¨",
              "color": 15548997,
              "fields": [
                  {"name": "Repository", "value": "${{ inputs.repository }}", "inline": false},
                  {"name": "Environment", "value": "${{ inputs.environment }}", "inline": true},
                  {"name": "Merge To", "value": "${{ inputs.base_ref }}", "inline": true},
                  {"name": "Triggered By", "value": "${{ inputs.actor }}", "inline": false},
                  {"name": "Commit/PR", "value": "${{ inputs.pr_title }}", "inline": false},
                  {"name": "Actions Log", "value": "[Link to Action](https://github.com/${{ inputs.repository }}/actions/runs/${{ inputs.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: '${{ inputs.environment }} ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ í™•ì¸ í•„ìš”. <@&${{ secrets.DISCORD_ROLE_BACKEND_ONCALL }}>'