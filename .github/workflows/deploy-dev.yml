name: Backend Deploy to Dev

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      image_uri:
        description: 'ë°°í¬í•  Docker ì´ë¯¸ì§€ URI (ì˜ˆ: .../backend:dev-latest)'
        required: true
        type: string
      instance_tag_name:
        description: 'EC2ë¥¼ ì°¾ì„ íƒœê·¸ Key'
        required: true
        type: string
      instance_tag_value:
        description: 'EC2ë¥¼ ì°¾ì„ íƒœê·¸ Value'
        required: true
        type: string
      pr_number:
        description: 'PR ë²ˆí˜¸'
        required: true
        type: number
      pr_title:
        description: 'PR ì œëª©'
        required: true
        type: string
      base_ref:
        description: 'ë² ì´ìŠ¤ ë¸Œëœì¹˜ (main, dev)'
        required: true
        type: string
      actor:
        description: 'Triggered by (GitHub ì‚¬ìš©ì)'
        required: true
        type: string
      repository:
        description: 'Repository ì´ë¦„'
        required: true
        type: string
      run_id:
        description: 'GitHub Actions Run ID'
        required: true
        type: string
    secrets:
      DISCORD_WEBHOOK_URL:
        required: true
      DISCORD_ROLE_BACKEND:
        required: true
      DISCORD_ROLE_BACKEND_ONCALL:
        required: true
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-2

jobs:
  deploy-via-ssm:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # OIDCë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ Role ARNì„ Secretsì—ì„œ ê°€ì ¸ì˜´
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Find Target Instance
        id: find-instance
        run: |
          echo "Finding instance with tag ${{ inputs.instance_tag_name }}=${{ inputs.instance_tag_value }}..."
          
          # íƒœê·¸ë¥¼ ì´ìš©í•´ì„œ Running ìƒíƒœì¸ ì¸ìŠ¤í„´ìŠ¤ ID ì°¾ê¸°
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:${{ inputs.instance_tag_name }},Values=${{ inputs.instance_tag_value }}" "Name=instance-state-name,Values=running" \
            --query "Reservations[*].Instances[*].InstanceId" \
            --output text)

          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" == "None" ]; then
            echo "Error: No running instance found!"
            exit 1
          fi

          echo "Target Instance ID: $INSTANCE_ID"
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Send SSM Command (Docker Compose Up)
        run: |
          echo "Deploying Image: ${{ inputs.image_uri }}"

          # SSM ëª…ë ¹ ì „ì†¡ (ë¹„ë™ê¸°ë¡œ ì‹¤í–‰)
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ steps.find-instance.outputs.INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploying backend to Dev" \
            --parameters commands='[
              "echo \"=== Start Deployment ===\"",
              "cd /home/ssm-user/app", 
              
              "echo \"1. Login to ECR\"",
              "ECR_REGISTRY=$(echo ${{ inputs.image_uri }} | cut -d/ -f1)",
              "aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY",
            
              "export ECR_REGISTRY=$ECR_REGISTRY",
              "export BACKEND_IMAGE_URI=${{ inputs.image_uri }}",

              "echo \"2. Backup Current Image\"",
              "if docker image inspect $ECR_REGISTRY/backend:dev-latest > /dev/null 2>&1; then",
              "  echo \"Found existing image. Tagging as backup...\"",
              "  docker tag $ECR_REGISTRY/backend:dev-latest backend:rollback-backup",
              "else",
              "  echo \"No existing image found. Skipping backup.\"",
              "fi",
              
              "echo \"3. Pull New Image\"",
              "docker compose pull backend || { echo \"âŒ Docker pull failed!\"; exit 1; }",
              
              "echo \"4. Restart Container\"",
              "docker compose up -d backend",

              "echo \"5. Health Check & Verification (Critical Step)\"",
              "echo \"Waiting for Backend to be ready...\"",

              "# ìµœëŒ€ 60ì´ˆ ëŒ€ê¸° (5ì´ˆ * 12íšŒ)",
              "IS_HEALTHY=false",
              "FOR_LIMIT=12",

              "for i in $(seq 1 $FOR_LIMIT); do",
              "  # 5-1. ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸",
              "  if [ -z \"$(docker compose ps -q backend)\" ]; then",
              "    echo \"âŒ Container is not running!\"",
              "    docker compose logs backend --tail 20",
              "    break",
              "  fi",
              
              "  # 5-2. API ì‘ë‹µ í™•ì¸ (Health Check)",
              "  # curl -f: ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì½”ë“œ ë°˜í™˜, -s: ì¡°ìš©íˆ",
              "  if curl -s -f http://localhost:8080/health > /dev/null; then",
              "    echo \"âœ… Health Check Passed! Deployment Complete.\"",
              "    IS_HEALTHY=\"true\"",
              "    break",
              "  fi",
              
              "  echo \"â³ App is starting... ($i/$FOR_LIMIT)\"",
              "  sleep 5",
              "done",

              "if [ \"$IS_HEALTHY\" = \"true\" ]; then",
              "  echo \"âœ… Deployment Configured Successfully.\"",
              "  docker rmi backend:rollback-backup 2>/dev/null || true",
              "  docker image prune -f",
              "  exit 0",

              "else",
              "  echo \"ğŸš¨ Health Check Failed! Initiating Rollback...\"",
              
              "  # ë¡¤ë°± ì‹¤í–‰: ë°±ì—…í•´ë‘” ì´ë¯¸ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸",
              "  if docker image inspect backend:rollback-backup > /dev/null 2>&1; then",
              "    echo \"Restoring previous image...\"",
              "    # ë°±ì—… ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ dev-latestë¡œ íƒœê¹…",
              "    docker tag backend:rollback-backup $ECR_REGISTRY/backend:dev-latest",
              "    # ê°•ì œë¡œ ë‹¤ì‹œ ì»¨í…Œì´ë„ˆ ìƒì„±",
              "    docker compose up -d --force-recreate backend",
              "    echo \"âœ… Rollback Complete. Server is running on previous version.\"",
              "  else",
              "    echo \"âŒ No backup image found. Cannot rollback.\"",
              "  fi",
              
              "  # ë¡¤ë°±ì„ í–ˆë”ë¼ë„ ë°°í¬ ìì²´ëŠ” ì‹¤íŒ¨í•œ ê²ƒì´ë¯€ë¡œ exit 1",
              "  echo \"=== Error Logs ===\"",
              "  docker compose logs backend --tail 50",
              "  exit 1",
              "fi"
            ]' \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command Sent! ID: $COMMAND_ID"

          # ëª…ë ¹ì´ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸° ë° ê²°ê³¼ í™•ì¸
          echo "Waiting for command execution..."
          while :; do
            STATUS=$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "${{ steps.find-instance.outputs.INSTANCE_ID }}" --query "Status" --output text)
            
            if [[ "$STATUS" == "Success" ]]; then
              echo "Deployment Successful!"
              echo "=== Command Output ==="
              aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "${{ steps.find-instance.outputs.INSTANCE_ID }}" --query "StandardOutputContent" --output text
              exit 0
            elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" || "$STATUS" == "TimedOut" ]]; then
              echo "Deployment Failed! Status: $STATUS"
              # ì‹¤íŒ¨ ì›ì¸ ë¡œê·¸ ì¶œë ¥
              echo "=== Standard Output ==="
              aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "${{ steps.find-instance.outputs.INSTANCE_ID }}" --query "StandardOutputContent" --output text
              echo "=== Standard Error ==="
              aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "${{ steps.find-instance.outputs.INSTANCE_ID }}" --query "StandardErrorContent" --output text
              exit 1
            fi
            
            echo "Status: $STATUS... Waiting 10s"
            sleep 10
          done

      # í˜„ì¬ ì‹œê°„ êµ¬í•˜ê¸° (KST)
      - name: Get Current Time
        if: always()
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: 'YYYY-MM-DD HH:mm:ss'
          utcOffset: "+09:00" # í•œêµ­ ì‹œê°„
          timezone: 'Asia/Seoul'

      # Discord ì„±ê³µ ì•Œë¦¼
      - name: Discord Notification - Success
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "âœ… ${{ inputs.environment }} BE ë°°í¬(CD) ì„±ê³µ", 
              "color": 5763719,
              "fields": [
                {"name": "Repository", "value": "${{ inputs.repository }}", "inline": false},
                {"name": "Environment", "value": "${{ inputs.environment }}", "inline": true},
                {"name": "Merge To", "value": "${{ inputs.base_ref }}", "inline": true},
                {"name": "Triggered By", "value": "${{ inputs.actor }}", "inline": false},
                {"name": "Commit/PR", "value": "${{ inputs.pr_title }}", "inline": false},
                {"name": "Version", "value": "${{ env.DEPLOY_TAG || 'N/A' }}", "inline": true},
                {"name": "Actions Log", "value": "[Link to Action](https://github.com/${{ inputs.repository }}/actions/runs/${{ inputs.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: '${{ inputs.environment }} ë°°í¬ ì™„ë£Œ! <@&${{ secrets.DISCORD_ROLE_BACKEND }}>'

      # Discord ì‹¤íŒ¨ ì•Œë¦¼
      - name: Discord Notification - Failure
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_EMBEDS: |
            [{
              "title": "ğŸš¨ ${{ inputs.environment }} BE ë°°í¬(CD) ì‹¤íŒ¨",
              "color": 15548997,
              "fields": [
                {"name": "Repository", "value": "${{ inputs.repository }}", "inline": false},
                {"name": "Environment", "value": "${{ inputs.environment }}", "inline": true},
                {"name": "Merge To", "value": "${{ inputs.base_ref }}", "inline": true},
                {"name": "Triggered By", "value": "${{ inputs.actor }}", "inline": false},
                {"name": "Commit/PR", "value": "${{ inputs.pr_title }}", "inline": false},
                {"name": "Actions Log", "value": "[Link to Action](https://github.com/${{ inputs.repository }}/actions/runs/${{ inputs.run_id }})", "inline": true}
              ],
              "footer": {
                "text": "${{ steps.current-time.outputs.formattedTime }} KST"
              }
            }]
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: '${{ inputs.environment }} ë°°í¬ ì‹¤íŒ¨! ë¡œê·¸ í™•ì¸ í•„ìš” <@&${{ secrets.DISCORD_ROLE_BACKEND_ONCALL }}>'