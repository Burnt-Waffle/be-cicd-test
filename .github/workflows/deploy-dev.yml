name: Backend Deploy to Dev

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      image_uri:
        description: '배포할 Docker 이미지 URI (예: .../backend:dev-latest)'
        required: true
        type: string
      instance_tag_name:
        description: 'EC2를 찾을 태그 Key (예: Environment)'
        required: true
        type: string
      instance_tag_value:
        description: 'EC2를 찾을 태그 Value (예: dev)'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-2

jobs:
  deploy-via-ssm:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # OIDC를 사용하므로 Role ARN을 Secrets에서 가져옴
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Find Target Instance
        id: find-instance
        run: |
          echo "Finding instance with tag ${{ inputs.instance_tag_name }}=${{ inputs.instance_tag_value }}..."
          
          # 태그를 이용해서 Running 상태인 인스턴스 ID 찾기
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:${{ inputs.instance_tag_name }},Values=${{ inputs.instance_tag_value }}" "Name=instance-state-name,Values=running" \
            --query "Reservations[*].Instances[*].InstanceId" \
            --output text)

          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" == "None" ]; then
            echo "Error: No running instance found!"
            exit 1
          fi

          echo "Target Instance ID: $INSTANCE_ID"
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Send SSM Command (Docker Compose Up)
        run: |
          echo "Deploying Image: ${{ inputs.image_uri }}"

          # SSM 명령 전송 (비동기)
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ steps.find-instance.outputs.INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploying backend to Dev" \
            --parameters commands='[
              "echo \"=== Start Deployment ===\"",
              "cd /home/ssm-user/app", 
              
              "echo \"1. Login to ECR\"",
              "ECR_REGISTRY=$(echo ${{ inputs.image_uri }} | cut -d/ -f1)",
              "aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY",
              
              "echo \"2. Set Environment Variable\"",
              "export ECR_REGISTRY=$ECR_REGISTRY",
              "export BACKEND_IMAGE_URI=${{ inputs.image_uri }}",

              "echo \"--- Debug: Check Configuration ---\"",
              "docker compose config",
              
              "echo \"3. Pull New Image\"",
              "docker compose pull backend",
              
              "echo \"4. Restart Container (Rolling Update style)\"",
              "docker compose up -d backend",

              "echo \"5. Health Check & Verification (Critical Step)\"",
              "echo \"Waiting for Backend to be ready...\"",

              "# 최대 60초 대기 (5초 * 12회)",
              "FOR_LIMIT=12",
              "for i in $(seq 1 $FOR_LIMIT); do",
              "  # 5-1. 컨테이너가 실행 중인지 확인",
              "  if [ -z \"$(docker compose ps -q backend)\" ]; then",
              "    echo \"❌ Container is not running!\"",
              "    docker compose logs backend --tail 20",
              "    exit 1",
              "  fi",
              
              "  # 5-2. API 응답 확인 (Health Check)",
              "  # curl -f: 실패 시 에러 코드 반환, -s: 조용히",
              "  if curl -s -f http://localhost:8080/health > /dev/null; then",
              "    echo \"✅ Health Check Passed! Deployment Complete.\"",
              "    docker image prune -f",
              "    exit 0",
              "  fi",
              
              "  echo \"⏳ App is starting... ($i/$FOR_LIMIT)\"",
              "  sleep 5",
              "done",
              
              " # 6. 루프가 끝날 때까지 성공 못하면 타임아웃 처리",
              "echo \"❌ Deployment Failed: Health Check Timed Out!\"",
              "echo \"=== Container Logs ===\"",
              "docker compose logs backend --tail 50",
              "exit 1",
            ]' \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command Sent! ID: $COMMAND_ID"
          
          # 명령이 끝날 때까지 대기 및 결과 확인 (Polling)
          echo "Waiting for SSM command to finish..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ steps.find-instance.outputs.INSTANCE_ID }}"

          # 3. 결과 확인 (성공/실패 여부만 딱 한 번 체크)
          STATUS=$(aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "${{ steps.find-instance.outputs.INSTANCE_ID }}" --query "Status" --output text)
          
          if [[ "$STATUS" == "Success" ]]; then
            echo "✅ Deployment Successful!"
            exit 0
          else
            echo "❌ Deployment Failed! Status: $STATUS"
            # 실패 로그 출력 로직...
            exit 1
          fi